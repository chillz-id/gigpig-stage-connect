<!DOCTYPE html>
<html>
<head>
    <title>Profile Update Test</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        img { max-width: 200px; height: 200px; object-fit: cover; border: 2px solid #333; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Profile Picture Update Test</h1>
    
    <div class="test-section">
        <h2>Current Profile Picture</h2>
        <img id="profileImg" alt="Profile" />
        <div id="imageUrl" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Force Refresh Test</h2>
        <button onclick="forceRefresh()">Force Refresh Avatar</button>
        <button onclick="clearCache()">Clear Browser Cache</button>
        <button onclick="addTimestamp()">Add Timestamp to URL</button>
    </div>

    <div class="test-section">
        <h2>Debug Log</h2>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        const log = (msg) => {
            const debugLog = document.getElementById('debugLog');
            debugLog.innerHTML += `[${new Date().toISOString()}] ${msg}<br>`;
        };

        // Get current user's profile
        const loadProfile = async () => {
            try {
                const response = await fetch('/api/profile');
                const data = await response.json();
                
                if (data.avatar_url) {
                    document.getElementById('profileImg').src = data.avatar_url;
                    document.getElementById('imageUrl').textContent = data.avatar_url;
                    log(`Profile loaded: ${data.avatar_url}`);
                } else {
                    log('No avatar URL found in profile');
                }
            } catch (error) {
                log(`Error loading profile: ${error.message}`);
            }
        };

        const forceRefresh = () => {
            const img = document.getElementById('profileImg');
            const currentSrc = img.src;
            
            // Remove from DOM and re-add
            const parent = img.parentNode;
            parent.removeChild(img);
            
            const newImg = document.createElement('img');
            newImg.id = 'profileImg';
            newImg.alt = 'Profile';
            newImg.src = currentSrc + '?t=' + Date.now();
            parent.insertBefore(newImg, parent.firstChild);
            
            log('Forced image refresh with new timestamp');
        };

        const clearCache = () => {
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                    log('Browser cache cleared');
                });
            } else {
                log('Cache API not supported');
            }
        };

        const addTimestamp = () => {
            const img = document.getElementById('profileImg');
            const url = new URL(img.src);
            url.searchParams.set('t', Date.now());
            img.src = url.toString();
            document.getElementById('imageUrl').textContent = img.src;
            log('Added timestamp to image URL');
        };

        // Test if the image actually loads
        window.onload = () => {
            const img = document.getElementById('profileImg');
            img.onload = () => log('Image loaded successfully');
            img.onerror = () => log('Image failed to load');
            
            // Try to load profile
            loadProfile();
        };
    </script>
</body>
</html>